{% extends "base.html" %}
{% load static %}

{% block title %}{{ post.meta_title|default:post.title }} | Abbas Lotfinasab{% endblock %}

{% block extra_head %}
<meta name="description" content="{{ post.meta_description|default:post.content|truncatechars:160 }}">
<link rel="canonical" href="{{ post.canonical_url|default:request.build_absolute_uri }}"/>

<!-- Open Graph -->
<meta property="og:type" content="article">
<meta property="og:title" content="{{ post.meta_title|default:post.title }}">
<meta property="og:description" content="{{ post.meta_description|default:post.content|truncatechars:160 }}">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
{% if post.og_image %}
  <meta property="og:image" content="{{ post.og_image.url }}">
{% elif post.image %}
  <meta property="og:image" content="{{ post.image.url }}">
{% else %}
  <meta property="og:image" content="{% static 'images/og-default.jpg' %}">
{% endif %}

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ post.meta_title|default:post.title }}">
<meta name="twitter:description" content="{{ post.meta_description|default:post.content|truncatechars:160 }}">
{% if post.og_image %}
  <meta name="twitter:image" content="{{ post.og_image.url }}">
{% elif post.image %}
  <meta name="twitter:image" content="{{ post.image.url }}">
{% endif %}

<!-- JSON-LD: BlogPosting -->
<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"BlogPosting",
  "headline": "{{ post.meta_title|default:post.title|escapejs }}",
  "datePublished":"{{ post.created_at|date:'c' }}",
  "author":{"@type":"Person","name":"Abbas Lotfinasab"},
  "image":[
    {% if post.og_image %}"{{ post.og_image.url }}"{% elif post.image %}"{{ post.image.url }}"{% else %}""{% endif %}
  ],
  "mainEntityOfPage":{"@type":"WebPage","@id":"{{ request.build_absolute_uri }}"},
  "description":"{{ post.meta_description|default:post.content|truncatechars:160|escapejs }}"
}
</script>
{% endblock %}

{% block content %}
<section class="py-5" style="background:#f8fafc">
  <div class="container">
    <div class="col-lg-8 offset-lg-2">
      <article class="post-card rounded-4 shadow-sm bg-white p-4 p-md-5 mb-4 border">
        <!-- Header -->
        <header class="d-flex align-items-center mb-3">
          <img src="{% static 'images/logo.png' %}" width="44" height="44" class="rounded-circle ms-2" alt="ALH">
          <div>
            <div class="fw-bold">عباس لطفی نسب</div>
            <div class="small text-muted">{{ post.created_at|date:"Y/m/d H:i" }}</div>
          </div>
        </header>

        <!-- Tags -->
        {% if post.tags.all %}
        <div class="d-flex flex-wrap gap-1 mb-3">
          {% for t in post.tags.all %}
            <a class="badge bg-light text-dark border text-decoration-none"
               href="{% url 'posts:feed' %}?tag={{ t.slug }}"># {{ t.name }}</a>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Title -->
        {% if post.title %}
          <h1 class="h3 fw-bold mb-3" style="color:#003c70">{{ post.title }}</h1>
        {% endif %}

        <!-- Media -->
        {% if post.image %}
          <img src="{{ post.image.url }}" class="img-fluid rounded mb-3" alt="{{ post.title|default:'post image' }}" loading="eager" fetchpriority="high">
        {% endif %}
        {% if post.video %}
          <video class="w-100 rounded mb-3" controls preload="metadata">
            <source src="{{ post.video.url }}" type="video/mp4">
          </video>
        {% endif %}

        <!-- Content -->
        <div class="post-content fs-6 lh-lg" dir="auto">
          {{ post.content|linebreaksbr }}
        </div>

        <!-- Counters -->
        <div class="d-flex justify-content-between align-items-center text-muted small mt-4 pt-3 border-top">
          <span>👁 {{ post.views }}</span>
          <span>👍 {{ post.likes }}</span>
          <span>💬 {{ post.comments_count }}</span>
        </div>

        <!-- Actions -->
        <div class="d-flex gap-2 mt-2">
          <button id="likeBtn" class="btn btn-sm btn-light">👍 پسندیدم</button>
          <button id="shareBtn" class="btn btn-sm btn-light">↗️ اشتراک‌گذاری</button>
          <a href="{% url 'posts:feed' %}" class="btn btn-sm btn-outline-secondary">بازگشت به روزنوشت‌ها</a>
        </div>
      </article>

      {% if related %}
      <div class="mb-4">
        <h2 class="h6 fw-bold mb-3" style="color:#003c70">پست‌های مرتبط</h2>
        <div class="row g-3">
          {% for r in related %}
          <div class="col-12 col-md-6">
            <a class="d-block p-3 rounded-4 bg-white border text-decoration-none link-dark hover-shadow" href="{% url 'posts:detail' r.slug %}">
              <div class="small text-muted mb-1">{{ r.created_at|date:"Y/m/d" }}</div>
              <div class="fw-bold">{{ r.title|default:r.content|truncatechars:60 }}</div>
            </a>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
(function(){
  const likeBtn = document.getElementById("likeBtn");
  if (likeBtn){
    likeBtn.addEventListener("click", async ()=>{
      try{
        const res = await fetch("/api/posts/posts/{{ post.id }}/like/", {method:"POST"});
        const data = await res.json();
        likeBtn.classList.add("btn-primary"); likeBtn.classList.remove("btn-light");
      }catch(e){}
    });
  }
  const shareBtn = document.getElementById("shareBtn");
  if (shareBtn){
    shareBtn.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(location.href);
        shareBtn.textContent = "کپی شد";
        setTimeout(()=>shareBtn.textContent="↗️ اشتراک‌گذاری", 1200);
      }catch(e){}
    });
  }
})();
</script>
{% endblock %}
