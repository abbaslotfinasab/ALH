{% extends "base.html" %}
{% block content %}
<section class="py-5">
  <div class="container">
    <div class="row g-4">
      <div class="col-lg-8">
        <article class="card border-0 shadow-sm rounded-4">
          {% if post.cover %}
          <img src="{{ post.cover.url }}" class="card-img-top rounded-top-4" alt="{{ post.title }}">
          {% endif %}
          <div class="card-body p-4">
            <h1 class="fw-bold">{{ post.title }}</h1>
            <div class="text-muted small mb-3">انتشار: {{ post.created_at|date:"Y-m-d" }}</div>
            <div class="mb-4 text-muted">{{ post.excerpt }}</div>

            <div class="content rich-text">
              {{ post.content|safe }}
            </div>

            {% if post.gallery.all %}
            <div class="mt-4">
              <h6 class="fw-semibold">گالری تصاویر</h6>
              <div class="row g-2">
                {% for img in post.gallery.all %}
                <div class="col-6 col-md-4">
                  <img src="{{ img.image.url }}" class="img-fluid rounded" alt="{{ img.caption }}">
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>
        </article>

        <!-- actions -->
        <div class="d-flex gap-2 mt-3 align-items-center">
          <button id="likeBtn" data-id="{{ post.id }}" class="btn btn-outline-primary btn-sm">👍 پسندیدم <span id="likeCount">{{ post.likes }}</span></button>
          <div class="metric-pill d-flex align-items-center gap-1 px-2 py-1 rounded-pill bg-light">
            <i data-lucide="eye"></i> <span id="viewCount">{{ post.views }}</span>
          </div>
        </div>

      </div>

      <aside class="col-lg-4">
        <div class="p-4 rounded-4 shadow-sm bg-white border">
          <h6 class="fw-bold mb-3">تگ‌ها</h6>
          <div class="d-flex flex-wrap gap-2">
            {% for tag in post.tags.all %}
              <a href="{% url 'blogs:post_list' %}?tag={{ tag.slug }}" class="badge bg-light text-dark border"># {{ tag.name }}</a>
            {% endfor %}
          </div>
        </div>

        <div class="p-4 rounded-4 shadow-sm bg-white border mt-4">
          <h6 class="fw-bold mb-3">مطالب مرتبط</h6>
          <ul class="list-unstyled small">
            {% for p in post.tags.first.posts.exclude(id=post.id)|slice:":5" %}
              <li><a href="{{ p.get_absolute_url }}">{{ p.title }}</a></li>
            {% empty %}
              <li class="text-muted">مورد مرتبطی یافت نشد.</li>
            {% endfor %}
          </ul>
        </div>
      </aside>
    </div>
  </div>
</section>

<script>
document.getElementById('likeBtn')?.addEventListener('click', async function(){
  const id = this.dataset.id;
  try {
    const res = await fetch("{% url 'blogs:api-posts-list' %}" + id + "/like/", { method: "POST", headers: {"X-CSRFToken": "{{ csrf_token }}" }});
    const data = await res.json();
    if (data.likes !== undefined) {
      document.getElementById('likeCount').textContent = data.likes;
    }
  } catch(e) { console.error(e) }
});
</script>

{% endblock %}
