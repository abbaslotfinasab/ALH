{# templates/posts/feed.html #}
{% extends "base.html" %}

{% block content %}
<section class="py-5" style="background:#f8fafc">
  <div class="container">
    <div class="text-center mb-4">
      <h1 class="section-title">روزنوشت‌ها</h1>
      <p class="section-subtitle">یادداشت‌های کوتاه کاری، فنی و روزمره.</p>
    </div>

    <!-- فیلتر تگ‌ها -->
    <div id="tagsBar" class="d-flex justify-content-center flex-wrap gap-2 mb-4">
      <button class="btn btn-sm tag-pill active" data-tag="">همه</button>
      {% for t in tags %}
        <button class="btn btn-sm tag-pill" data-tag="{{ t.name }}">{{ t.name }}</button>
      {% endfor %}
    </div>

    <!-- فید -->
    <div id="feed" class="col-lg-8 offset-lg-2"></div>
    <div id="sentinel" class="py-4 text-center text-muted small">در حال بارگذاری…</div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
(function(){
  const API_BASE = "/api/posts/posts/";
  let nextUrl = API_BASE;      // صفحه اول
  let loading = false;
  let activeTag = "";          // نام تگ فعال

  // UI: استایل Pillها
  document.querySelectorAll(".tag-pill").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tag-pill").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      activeTag = btn.dataset.tag || "";
      // ریست فید
      document.getElementById("feed").innerHTML = "";
      nextUrl = activeTag ? `${API_BASE}?tags__name=${encodeURIComponent(activeTag)}` : API_BASE;
      fetchMore(true);
    });
  });

  // رندر کارت
  function renderPostCard(p){
    const media = p.image ? `<img src="${p.image}" class="img-fluid rounded mb-3" alt="">`
               : (p.video ? `<video class="w-100 rounded mb-3" controls src="${p.video}"></video>` : "");
    const date = new Date(p.created_at).toLocaleString("fa-IR");
    const tags = (p.tags||[]).map(t=>`<span class="badge bg-light text-dark border me-1">${t.name}</span>`).join("");

    return `
    <article class="post-card rounded-4 shadow-sm bg-white p-4 mb-4">
      <header class="d-flex align-items-center mb-3">
        <img src="/static/images/logo.png" width="40" height="40" class="rounded-circle ms-2" alt="ALH">
        <div>
          <div class="fw-bold">عباس لطفی نسب</div>
          <div class="small text-muted">${date}</div>
        </div>
      </header>
      <div class="small mb-2">${tags}</div>
      <p class="mb-3" dir="auto">${p.content.length>550 ? p.content.slice(0,550)+'…' : p.content}</p>
      ${media}
      <div class="d-flex justify-content-between align-items-center text-muted small mb-2">
        <span>👁 <span class="vcount">${p.views}</span></span>
        <span>👍 <span class="lcount">${p.likes}</span></span>
        <span>💬 ${p.comments_count}</span>
      </div>
      <div class="d-flex justify-content-around border-top pt-2">
        <button class="btn btn-sm btn-light like-btn" data-id="${p.id}">👍 پسندیدم</button>
        <a class="btn btn-sm btn-light" href="/notes/${p.slug}/">خواندن کامل</a>
        <button class="btn btn-sm btn-light share-btn" data-url="${location.origin}/notes/${p.slug}/">↗️ اشتراک‌گذاری</button>
      </div>
    </article>`;
  }

  // لود صفحه بعد
  async function fetchMore(reset=false){
    if (loading || !nextUrl) return;
    loading = true;
    document.getElementById("sentinel").style.opacity = 1;
    const res = await fetch(nextUrl);
    const data = await res.json();
    nextUrl = data.next;
    const html = data.results.map(renderPostCard).join("");
    document.getElementById("feed").insertAdjacentHTML("beforeend", html);
    bindActions();
    // ثبت بازدید اولیه برای کارت‌های تازه
    document.querySelectorAll(".post-card").forEach(card=>{
      const id = card.querySelector(".like-btn").dataset.id;
      fetch(`${API_BASE}${id}/viewed/`, {method:"POST"});
    });
    document.getElementById("sentinel").style.opacity = nextUrl ? 1 : 0;
    loading = false;
  }

  // اکشن‌ها (Like/Share)
  function bindActions(){
    document.querySelectorAll(".like-btn").forEach(btn=>{
      if (btn.dataset.bound) return;
      btn.dataset.bound = "1";
      btn.addEventListener("click", async ()=>{
        const id = btn.dataset.id;
        const res = await fetch(`${API_BASE}${id}/like/`, {method:"POST"});
        const data = await res.json();
        const card = btn.closest(".post-card");
        if (card && data.likes !== undefined){
          card.querySelector(".lcount").textContent = data.likes;
          btn.classList.add("btn-primary"); btn.classList.remove("btn-light");
        }
      });
    });
    document.querySelectorAll(".share-btn").forEach(b=>{
      if (b.dataset.bound) return;
      b.dataset.bound = "1";
      b.addEventListener("click", async ()=>{
        try { await navigator.clipboard.writeText(b.dataset.url); b.textContent="کپی شد"; setTimeout(()=>b.textContent="↗️ اشتراک‌گذاری",1000);}catch(e){}
      });
    });
  }

  // اینفینیت اسکرول
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{ if(e.isIntersecting) fetchMore(); });
  },{rootMargin:"600px"});
  io.observe(document.getElementById("sentinel"));

  // استارت
  fetchMore(true);
})();
</script>
