{% extends "base.html" %}
{% block content %}
<section class="feed-section py-5">
    <div class="container">

        <!-- Search -->
        <div class="feed-search bg-transparent">
            <div class="search-wrap shadow-sm rounded-4 p-2 p-md-3">
                <form class="row g-2 align-items-center" role="search" onsubmit="return false;">
                    <div class="col-12 col-md">
                        <div class="search-input d-flex align-items-center gap-2 px-3 py-2 rounded-3">
                            <i class="fa-solid fa-magnifying-glass search-ico"></i>
                            <input id="qInput" type="search" inputmode="search" autocomplete="off"
                                   class="form-control border-0 bg-transparent"
                                   placeholder="جستجو بین عنوان و متن پست‌ها…">
                            <button id="clearSearch" class="btn btn-clear d-none" type="button"
                                    aria-label="پاک کردن جستجو">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-6 col-md-auto">
                        <div class="date-chip d-flex align-items-center gap-2 px-3 py-2 rounded-3">
                            <i class="fa-regular fa-calendar"></i>
                            <input id="dateInput" type="date"
                                   class="form-control form-control-sm border-0 bg-transparent">
                            <button id="clearDate" class="btn btn-clear" type="button" aria-label="پاک کردن تاریخ">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Feed -->
        <div class="row justify-content-center mt-4">
            <div class="col-lg-8">
                <div id="feed"></div>

                <div id="spinner" class="text-center py-4 d-none">
                    <div class="spinner-border text-success" role="status"></div>
                </div>

                <div id="sentinel" class="py-4 text-center text-muted small">در حال بارگذاری…</div>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="position-fixed bottom-0 end-0 m-4 bg-white px-3 py-2 rounded-3 d-none shadow">
            کپی شد ✅
        </div>
    </div>
</section>

<script>
    (function () {
        const API_POSTS = "/post/api/posts/";
        const API_COMMENTS = "/post/api/comments/";
        const feedEl = document.getElementById("feed");
        const sentinel = document.getElementById("sentinel");
        const spinner = document.getElementById("spinner");
        const toast = document.getElementById("toast");

        let nextUrl = null;
        let loading = false;
        let openSlug = new URLSearchParams(location.search).get("post") || "";

        // --- Helpers ---
        const showToast = msg => {
            toast.textContent = msg;
            toast.classList.remove("d-none");
            toast.classList.add("show");
            setTimeout(() => {
                toast.classList.remove("show");
                setTimeout(() => toast.classList.add("d-none"), 300);
            }, 1500);
        };

        const prettyNum = num =>
            num > 999999 ? (num / 1e6).toFixed(1) + "M"
                : num > 999 ? (num / 1e3).toFixed(1) + "K"
                    : num;

        // --- Templates ---
        const renderPost = p => {
            const date = new Date(p.created_at).toLocaleString("fa-IR");
            const media = p.image
                ? `<img src="${p.image}" class="img-fluid rounded mb-3" alt="${p.title}" loading="lazy">`
                : p.video
                    ? `<video class="w-100 rounded mb-3" controls><source src="${p.video}" type="video/mp4"></video>` : "";

            return `
    <article class="post-card rounded-4 shadow-sm bg-white p-4 mb-4" data-id="${p.id}">
      <header class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center">
          <img src="/static/images/logo.png" width="40" height="40" class="rounded-circle ms-2" alt="logo">
          <div>
            <div class="fw-bold">عباس لطفی نسب</div>
            <div class="small text-muted">${date}</div>
          </div>
        </div>
        <button class="btn share-btn" data-url="${location.origin}/post/?post=${p.slug}">
          <i class="fa-solid fa-share"></i>
        </button>
      </header>

      <div class="fw-bold mb-2">${p.title}</div>
      <p class="mb-4">${p.content}</p>
      ${media}

      <div class="post-actions d-flex gap-3 border-top pt-2 mt-3">
        <button class="btn like-btn ${p.liked ? "liked" : ""}" data-id="${p.id}">
          ❤️ <span class="lcount">${prettyNum(p.likes)}</span>
        </button>
        <span class="small text-muted"><i class="fa-solid fa-eye"></i> ${p.views}</span>
      </div>

      <div class="comments mt-4" id="comments-${p.id}">
        <h6 class="fw-bold mb-3">نظرات کاربران</h6>
        <div class="comments-list small mb-3 text-muted" id="list-${p.id}">در حال بارگذاری...</div>
        <button class="btn btn-outline-teal btn-sm w-100 d-none" id="loadmore-${p.id}">مشاهده بیشتر</button>
        <form class="comment-form d-flex gap-2 mt-3" data-post="${p.id}">
          <input type="text" class="form-control" placeholder="نظر شما..." required>
          <button class="btn btn-primary px-3">ارسال</button>
        </form>
      </div>
    </article>`;
        };

        // --- Fetch Posts ---
        async function fetchPosts() {
            if (loading) return;
            loading = true;
            spinner.classList.remove("d-none");
            const url = nextUrl || API_POSTS + (openSlug ? `?slug=${openSlug}` : "");
            try {
                const res = await fetch(url);
                const data = await res.json();
                nextUrl = data.next || null;
                const html = (data.results || []).map(renderPost).join("");
                feedEl.insertAdjacentHTML("beforeend", html);
                bindPostActions(data.results || []);
            } catch {
                feedEl.innerHTML = `<div class="text-danger text-center py-5">خطا در دریافت پست‌ها ❌</div>`;
            } finally {
                spinner.classList.add("d-none");
                loading = false;
            }
        }

        // --- Bind actions (likes, share, comments) ---
        function bindPostActions(posts) {
            posts.forEach(p => loadComments(p.id));

            document.querySelectorAll(".like-btn:not([data-bound])").forEach(btn => {
                btn.dataset.bound = "1";
                btn.addEventListener("click", async () => {
                    const id = btn.dataset.id;
                    const res = await fetch(`${API_POSTS}${id}/like/`, {method: "POST"});
                    const data = await res.json();
                    btn.querySelector(".lcount").textContent = prettyNum(data.likes);
                    btn.classList.toggle("liked", data.liked);
                });
            });

            document.querySelectorAll(".share-btn:not([data-bound])").forEach(btn => {
                btn.dataset.bound = "1";
                btn.addEventListener("click", async e => {
                    e.preventDefault();
                    await navigator.clipboard.writeText(btn.dataset.url);
                    showToast("لینک کپی شد ✅");
                });
            });

            document.querySelectorAll(".comment-form:not([data-bound])").forEach(form => {
                form.dataset.bound = "1";
                form.addEventListener("submit", async e => {
                    e.preventDefault();
                    const postId = form.dataset.post;
                    const input = form.querySelector("input");
                    const text = input.value.trim();
                    if (!text) return;
                    input.disabled = true;
                    try {
                        await fetch(API_COMMENTS, {
                            method: "POST",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({post: postId, text})
                        });
                        input.value = "";
                        loadComments(postId);
                    } catch {
                    }
                    input.disabled = false;
                });
            });
        }

        // --- Comments ---
        async function loadComments(postId, page = 1) {
            const list = document.getElementById(`list-${postId}`);
            const moreBtn = document.getElementById(`loadmore-${postId}`);
            try {
                const res = await fetch(`${API_COMMENTS}?post=${postId}&page=${page}`);
                const data = await res.json();
                const comments = data.results || [];
                if (!comments.length) {
                    list.innerHTML = `<div class="text-muted small">نظری ثبت نشده 😌</div>`;
                    return;
                }
                const html = comments
                    .slice(0, 5)
                    .map(c => `<div class="border rounded-3 p-2 mb-2"><div class="fw-bold small">${c.user_name || "کاربر مهمان"}</div><p class="mb-1">${c.text}</p></div>`)
                    .join("");
                list.innerHTML = html;
                if (comments.length > 5) {
                    moreBtn.classList.remove("d-none");
                    moreBtn.onclick = () => {
                        const extra = comments.slice(5)
                            .map(c => `<div class="border rounded-3 p-2 mb-2"><div class="fw-bold small">${c.user_name || "کاربر مهمان"}</div><p class="mb-1">${c.text}</p></div>`)
                            .join("");
                        list.insertAdjacentHTML("beforeend", extra);
                        moreBtn.remove();
                    };
                }
            } catch {
                list.innerHTML = `<div class="text-danger small">خطا در بارگذاری نظرات ❌</div>`;
            }
        }

        // --- Init ---
        fetchPosts();
    })();
</script>


{% endblock %}
