{% extends "base.html" %}
{% block content %}
<section class="feed-section py-5">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">

        {% for post in posts %}
        <article class="post-card rounded-4 shadow-sm bg-white p-4 mb-4">
          <header class="d-flex align-items-center mb-3 justify-content-between">
            <div class="d-flex align-items-center">
              <img src="/static/images/logo.png" width="40" height="40" class="rounded-circle ms-2" alt="ALH">
              <div>
                <div class="fw-bold">عباس لطفی نسب</div>
                <div class="small text-muted">{{ post.created_at|date:"Y/m/d H:i" }}</div>
              </div>
            </div>
            <button class="action-btn share-btn btn" data-url="{{ request.build_absolute_uri }}/post/{{ post.slug }}/">
              <i class="fa-solid fa-share"></i>
            </button>
          </header>

          <div class="fw-bold mb-2">{{ post.title }}</div>
          <p class="mb-4" dir="auto">{{ post.content|truncatechars:550|safe }}</p>

          {% if post.image %}
            <img src="{{ post.image.url }}" class="img-fluid rounded mb-3" alt="{{ post.title }}">
          {% elif post.video %}
            <video class="w-100 rounded mb-3" controls>
              <source src="{{ post.video.url }}" type="video/mp4">
            </video>
          {% endif %}

          <div class="post-actions d-flex gap-3 border-top pt-2 mt-3">
            <button class="action-btn btn view-btn" disabled>
              <i class="fa-solid fa-eye"></i> <span>{{ post.views }}</span>
            </button>

            <button
              class="action-btn btn like-btn {% if post.user_liked %}liked{% endif %}"
              data-id="{{ post.id }}">
              ❤️ <span class="lcount">{{ post.likes }}</span>
            </button>
          </div>
        </article>
        {% empty %}
          <p class="text-center text-muted">هیچ پستی پیدا نشد 😌</p>
        {% endfor %}

      </div>
    </div>
  </div>
</section>

<script>
document.querySelectorAll('.like-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const id = btn.dataset.id;
    const res = await fetch(`/post/api/posts/${id}/like/`, {method: 'POST'});
    const data = await res.json();

    if (data.likes !== undefined) {
      btn.querySelector('.lcount').textContent = data.likes;
      btn.classList.toggle('liked', data.liked);
    }
  });
});
</script>



{% endblock %}
