{% extends "base.html" %}
{% block content %}
<section class="feed-section py-5">
    <div class="container">

        <!-- Search Header -->
        <div class="feed-search bg-transparent">
            <div class="search-wrap shadow-sm rounded-4 p-2 p-md-3">
                <form class="row g-2 align-items-center" role="search" onsubmit="return false;">
                    <div class="col-12 col-md">
                        <div class="search-input d-flex align-items-center gap-2 px-3 py-2 rounded-3">
                            <i class="fa-solid fa-magnifying-glass search-ico"></i>
                            <input id="qInput" type="search" inputmode="search" autocomplete="off"
                                   class="form-control border-0 bg-transparent"
                                   placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨ÛŒÙ† Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù…ØªÙ† Ù¾Ø³Øªâ€ŒÙ‡Ø§â€¦">
                            <button id="clearSearch" class="btn btn-clear d-none" type="button"
                                    aria-label="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¬Ø³ØªØ¬Ùˆ">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-6 col-md-auto">
                        <div class="date-chip d-flex align-items-center gap-2 px-3 py-2 rounded-3">
                            <i class="fa-regular fa-calendar"></i>
                            <input id="dateInput" type="date"
                                   class="form-control form-control-sm border-0 bg-transparent">
                            <button id="clearDate" class="btn btn-clear" type="button" aria-label="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- ÙÛŒØ¯ -->
        <div class="row justify-content-center mt-4">
            <div class="col-lg-8">
                <div id="feed"></div>

                <!-- Spinner Ù…Ø±Ú©Ø²ÛŒ -->
                <div id="spinner" class="text-center py-4 d-none">
                    <div class="spinner-border text-success" role="status"></div>
                </div>

                <!-- sentinel Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†ÙÛŒÙ†ÛŒØª Ø§Ø³Ú©Ø±ÙˆÙ„ -->
                <div id="sentinel" class="py-4 text-center text-muted small">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>
            </div>
        </div>

        <!-- Toast Ø¨Ø±Ø§ÛŒ share -->
        <div id="toast" class="position-fixed bottom-0 end-0 m-4 bg-dark text-white px-3 py-2 rounded-3 d-none shadow">
            Ú©Ù¾ÛŒ Ø´Ø¯ âœ…
        </div>

        <!-- Post Popup -->
        <!-- Post Popup (Ø¬Ø²Ø¦ÛŒØ§Øª + Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§) -->
<div id="postPopup" class="post-popup d-none">
  <div class="popup-overlay"></div>
  <div class="popup-content rounded-4 shadow-lg bg-white d-flex flex-column flex-md-row">
    <div class="popup-media flex-grow-1 bg-dark">
      <img id="popupImage" class="img-fluid w-100 h-100 object-fit-cover d-none"/>
      <video id="popupVideo" class="w-100 h-100 d-none" controls></video>
    </div>
    <div class="popup-details p-3 p-md-4" style="width:400px; max-width:100%;">
      <button id="closePopup" class="btn-close float-end"></button>
      <div id="popupContent"></div>

      <!-- ğŸ‘‡ Ø¨Ø®Ø´ Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ -->
      <div id="commentsSection" class="mt-4">
        <h6 class="fw-bold mb-3">Ù†Ø¸Ø±Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h6>
        <div id="commentsList" class="comments-list mb-3 small text-muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        <button id="loadMoreComments" class="btn btn-outline-teal w-100 mb-3 d-none">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¨ÛŒØ´ØªØ±</button>

        <form id="commentForm" class="d-flex gap-2">
          <input type="text" id="commentInput" class="form-control rounded-pill" placeholder="Ù†Ø¸Ø± Ø´Ù…Ø§..." required>
          <button class="btn btn-primary rounded-pill px-3">Ø§Ø±Ø³Ø§Ù„</button>
        </form>
      </div>
    </div>
  </div>
</div>



    </div>
</section>

<script>
(function () {
  const API_BASE = "/post/api/posts/";
  const API_COMMENTS = "/post/api/comments/";

  const feedEl = document.getElementById("feed");
  const sentinel = document.getElementById("sentinel");
  const spinner = document.getElementById("spinner");
  const toast = document.getElementById("toast");

  const popupEl = document.getElementById("postPopup");
  const bsPopup = new bootstrap.Modal(popupEl);
  const img = document.getElementById("popupImage");
  const vid = document.getElementById("popupVideo");
  const content = document.getElementById("popupContent");

  const commentsList = document.getElementById("commentsList");
  const loadMoreBtn = document.getElementById("loadMoreComments");
  const commentForm = document.getElementById("commentForm");
  const commentInput = document.getElementById("commentInput");

  let nextUrl = null;
  let loading = false;
  let currentPostId = null;
  let nextCommentsUrl = null;

  // ğŸ§© Helpers
  function showSpinner(state = true) {
    spinner.classList.toggle("d-none", !state);
  }

  function showToast(msg) {
    toast.querySelector(".toast-body").textContent = msg;
    toast.classList.remove("d-none");
    setTimeout(() => toast.classList.add("d-none"), 1500);
  }

  function prettyNum(num) {
    if (num > 999999) return (num / 1e6).toFixed(1) + "M";
    if (num > 999) return (num / 1e3).toFixed(1) + "K";
    return num;
  }

  // ğŸ“° Ø±Ù†Ø¯Ø± Ú©Ø§Ø±Øª Ù¾Ø³Øª
  function renderPostCard(p) {
    const media = p.image
      ? `<img src="${p.image}" class="img-fluid rounded mb-3" alt="${p.title}" loading="lazy">`
      : p.video
      ? `<video class="w-100 rounded mb-3" controls preload="metadata" src="${p.video}"></video>`
      : "";
    const date = new Date(p.created_at).toLocaleString("fa-IR");

    return `
      <article class="post-card rounded-4 shadow-sm bg-white p-4 mb-4" data-id="${p.id}">
        <header class="d-flex align-items-center mb-3 justify-content-between">
          <div class="fw-bold">${p.title}</div>
          <div class="btn btn-light btn-sm share-btn" data-url="${location.origin}/post/${p.slug}/">
            <i class="fa-solid fa-share"></i>
          </div>
        </header>
        ${media}
        <p class="small mb-3">${p.content.slice(0, 200)}...</p>
        <div class="d-flex gap-3 border-top pt-2">
          <button class="btn btn-sm btn-outline-danger like-btn ${p.liked ? "liked" : ""}" data-id="${p.id}">
            â¤ï¸ <span class="lcount">${prettyNum(p.likes)}</span>
          </button>
          <button class="btn btn-sm btn-outline-primary comment-btn" data-id="${p.id}">ğŸ’¬ ${p.comments_count}</button>
        </div>
      </article>`;
  }

  // ğŸš€ Ù„ÙˆØ¯ Ù¾Ø³Øªâ€ŒÙ‡Ø§
  async function fetchMore() {
    if (loading || !nextUrl) return;
    loading = true;
    showSpinner(true);
    try {
      const res = await fetch(nextUrl);
      const data = await res.json();
      nextUrl = data.next || null;
      const html = (data.results || []).map(renderPostCard).join("");
      feedEl.insertAdjacentHTML("beforeend", html);
      bindActions();
    } finally {
      loading = false;
      showSpinner(false);
      sentinel.style.opacity = nextUrl ? 1 : 0;
    }
  }

  // â¤ï¸ğŸ’¬ Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§
  function bindActions() {
    document.querySelectorAll(".like-btn").forEach(btn => {
      if (btn.dataset.bound) return;
      btn.dataset.bound = "1";
      btn.addEventListener("click", async e => {
        const id = btn.dataset.id;
        const res = await fetch(`${API_BASE}${id}/like/`, { method: "POST" });
        const data = await res.json();
        if (data.likes !== undefined) {
          btn.querySelector(".lcount").textContent = prettyNum(data.likes);
          btn.classList.toggle("liked", data.liked);
        }
      });
    });

    document.querySelectorAll(".share-btn").forEach(btn => {
      if (btn.dataset.bound) return;
      btn.dataset.bound = "1";
      btn.addEventListener("click", async e => {
        try {
          await navigator.clipboard.writeText(btn.dataset.url);
          showToast("Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯ âœ…");
        } catch {}
      });
    });

    document.querySelectorAll(".comment-btn").forEach(btn => {
      if (btn.dataset.bound) return;
      btn.dataset.bound = "1";
      btn.addEventListener("click", async e => {
        const id = btn.dataset.id;
        const res = await fetch(`${API_BASE}${id}/`);
        const post = await res.json();
        openPopup(post);
      });
    });
  }

  // ğŸªŸ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ø§Ù¾â€ŒØ¢Ù¾
  function openPopup(post) {
    currentPostId = post.id;
    img.classList.add("d-none");
    vid.classList.add("d-none");

    if (post.image) (img.src = post.image), img.classList.remove("d-none");
    else if (post.video) (vid.src = post.video), vid.classList.remove("d-none");

    const date = new Date(post.created_at).toLocaleString("fa-IR");
    content.innerHTML = `
      <h5>${post.title}</h5>
      <p>${post.content}</p>
      <div class="small text-muted">${date}</div>
      <button class="btn btn-outline-danger mt-3 like-btn ${post.liked ? "liked" : ""}" data-id="${post.id}">
        â¤ï¸ ${prettyNum(post.likes)}
      </button>
    `;

    bsPopup.show();
    bindActions();
    loadComments(post.id);
  }

  // ğŸ—¨ï¸ Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§
  async function loadComments(postId, append = false) {
    try {
      const url = append && nextCommentsUrl ? nextCommentsUrl : `${API_COMMENTS}?post=${postId}`;
      const res = await fetch(url);
      const data = await res.json();

      nextCommentsUrl = data.next;
      const html = (data.results || []).map(renderComment).join("");
      if (append) commentsList.insertAdjacentHTML("beforeend", html);
      else commentsList.innerHTML = html || `<div class="text-center small text-muted">Ù‡Ù†ÙˆØ² Ù†Ø¸Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ ğŸ˜Œ</div>`;

      loadMoreBtn.classList.toggle("d-none", !nextCommentsUrl);
    } catch {
      commentsList.innerHTML = `<div class="text-danger small text-center">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø¸Ø±Ø§Øª âŒ</div>`;
    }
  }

  function renderComment(c) {
    const date = new Date(c.created_at).toLocaleString("fa-IR");
    return `
      <div class="comment-item mb-3 border rounded-3 p-2">
        <div class="fw-bold small">${c.user_name || "Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†"}</div>
        <div class="small text-muted">${date}</div>
        <div dir="auto">${c.text}</div>
      </div>`;
  }

  // ğŸ” Ù„ÙˆØ¯ Ø¨ÛŒØ´ØªØ±
  loadMoreBtn.addEventListener("click", () => loadComments(currentPostId, true));

  // âœï¸ Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ù…Ù†Øª
  commentForm.addEventListener("submit", async e => {
    e.preventDefault();
    const text = commentInput.value.trim();
    if (!text) return;
    commentInput.disabled = true;
    try {
      await fetch(API_COMMENTS, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ post: currentPostId, text }),
      });
      commentInput.value = "";
      await loadComments(currentPostId);
    } finally {
      commentInput.disabled = false;
    }
  });

  // ğŸŒ€ Infinite Scroll
  const io = new IntersectionObserver(entries => {
    entries.forEach(e => { if (e.isIntersecting) fetchMore(); });
  }, { rootMargin: "600px" });
  io.observe(sentinel);

  // ğŸ”° Init
  nextUrl = API_BASE;
  fetchMore();
})();
</script>


{% endblock %}
