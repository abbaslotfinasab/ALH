{% extends "base.html" %}
{% block content %}
<section class="feed-section py-5">
    <div class="container">

        <!-- Search -->
        <div class="feed-search bg-transparent">
            <div class="search-wrap shadow-sm rounded-4 p-2 p-md-3">
                <form class="row g-2 align-items-center" role="search" onsubmit="return false;">
                    <div class="col-12 col-md">
                        <div class="search-input d-flex align-items-center gap-2 px-3 py-2 rounded-3">
                            <i class="fa-solid fa-magnifying-glass search-ico"></i>
                            <input id="qInput" type="search" inputmode="search" autocomplete="off"
                                   class="form-control border-0 bg-transparent"
                                   placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨ÛŒÙ† Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù…ØªÙ† Ù¾Ø³Øªâ€ŒÙ‡Ø§â€¦">
                            <button id="clearSearch" class="btn btn-clear d-none" type="button"
                                    aria-label="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¬Ø³ØªØ¬Ùˆ">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-6 col-md-auto">
                        <div class="date-chip d-flex align-items-center gap-2 px-3 py-2 rounded-3">
                            <i class="fa-regular fa-calendar"></i>
                            <input id="dateInput" type="date"
                                   class="form-control form-control-sm border-0 bg-transparent">
                            <button id="clearDate" class="btn btn-clear" type="button" aria-label="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Feed -->
        <div class="row justify-content-center mt-4">
            <div class="col-lg-8">
                <div id="feed"></div>

                <div id="spinner" class="text-center py-4 d-none">
                    <div class="spinner-border text-success" role="status"></div>
                </div>

                <div id="sentinel" class="py-4 text-center text-muted small">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="position-fixed bottom-0 end-0 m-4 bg-white px-3 py-2 rounded-3 d-none shadow">
            Ú©Ù¾ÛŒ Ø´Ø¯ âœ…
        </div>
    </div>
</section>

<script>
    (function () {
        const API_BASE = "/post/api/posts/";
        const API_COMMENTS = "/post/api/comments/";
        const feedEl = document.getElementById("feed");
        const sentinel = document.getElementById("sentinel");
        const spinner = document.getElementById("spinner");
        const toast = document.getElementById("toast");


        // ---- State ----
        let nextUrl = null;
        let loading = false;
        let abortCtrl = null;


        // ---- Helpers ----
        window.showToast = function (msg) {
            const toast = document.getElementById("toast");
            toast.textContent = msg;
            toast.classList.remove("d-none");
            toast.classList.add("show");
            setTimeout(() => {
                toast.classList.remove("show");
                setTimeout(() => toast.classList.add("d-none"), 300);
            }, 1500);
        };


        const showSpinner = (state) => spinner.classList.toggle("d-none", !state);

        const prettyNum = (num) =>
            num > 999999 ? (num / 1e6).toFixed(1) + "M"
                : num > 999 ? (num / 1e3).toFixed(1) + "K"
                    : num;

        const buildApiUrl = (pageUrl = null) => {
            if (pageUrl) return pageUrl;
            const params = new URLSearchParams();
            if (activeTag) params.set("tags__slug", activeTag);
            if (activeQuery) params.set("search", activeQuery);
            if (activeDate) params.set("created_at__date", activeDate);
            return params.toString() ? `${API_BASE}?${params}` : API_BASE;
        };

        // ---- Templates ----
        const renderSkeleton = () =>
            `<div class="skeleton rounded-4 mb-4 p-4 bg-white shadow-sm">
      <div class="placeholder-glow mb-3">
        <div class="placeholder col-7"></div>
        <div class="placeholder col-4"></div>
      </div>
      <div class="placeholder-glow">
        <div class="placeholder col-12 mb-2"></div>
        <div class="placeholder col-10"></div>
      </div>
    </div>`;

        const renderPostCard = (p) => {
            const date = new Date(p.created_at).toLocaleString("fa-IR");
            const media = p.image
                ? `<img src="${p.image}" class="img-fluid rounded mb-3" alt="${p.title}" loading="lazy" decoding="async">`
                : p.video
                    ? `<video class="w-100 rounded mb-3" preload="none" controls poster="${p.thumbnail || ''}">
            <source src="${p.video}" type="video/mp4">
        </video>`
                    : "";

            const tags = (p.tags || [])
                .map(
                    (t) =>
                        `<a href="#" class="tag-link badge bg-light border me-1" data-tag="${t.slug || t.name}">
            # ${t.name}
          </a>`
                )
                .join("");

            const short =
                p.content.length > 550
                    ? `${p.content.slice(0, 550)}â€¦ <a href="/post/${p.slug}/" class="fw-semibold">Ø§Ø¯Ø§Ù…Ù‡ Ù…Ø·Ù„Ø¨</a>`
                    : p.content;

            return `
      <article class="post-card rounded-4 shadow-sm bg-white p-4 mb-4 fade-in" data-id="${p.id}">
        <header class="d-flex align-items-center mb-3 justify-content-between">
          <div class="d-flex align-items-center">
            <img src="/static/images/logo.png" width="40" height="40" class="rounded-circle ms-2" alt="ALH">
            <div>
              <div class="fw-bold">Ø¹Ø¨Ø§Ø³ Ù„Ø·ÙÛŒ Ù†Ø³Ø¨</div>
              <div class="small text-muted">${date}</div>
            </div>
          </div>
          <button class="share-btn more-link btn" data-url="${location.origin}/post/${p.slug}/">
            <i class="fa-solid fa-share"></i>
          </button>
        </header>

        <div class="fw-bold mb-2">${p.title}</div>
        <p class="mb-4" dir="auto">${short}</p>
        <div class="small mb-3">${tags}</div>
        ${media}

        <div class="post-actions d-flex gap-3 border-top pt-2 mt-3">
          <button class="action-btn btn view-btn">
            <i class="fa-solid fa-eye"></i> <span>${p.views}</span>
          </button>
          <button class="action-btn btn like-btn ${p.liked ? "liked" : ""}" data-id="${p.id}">
            â¤ï¸</i> <span class="lcount">${prettyNum(p.likes)}</span>
          </button>
          <button class="action-btn btn comment-btn" data-id="${p.id}">
            <i class="fa-solid fa-comment"></i> <span>${p.comments_count}</span>
          </button>
        </div>

        <div class="comments mt-4" id="comments-${p.id}">
        <h6 class="fw-bold mb-3">Ù†Ø¸Ø±Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h6>
        <div class="comments-list small mb-3 text-muted" id="list-${p.id}">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        <button class="btn btn-outline-teal btn-sm w-100 d-none" id="loadmore-${p.id}">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¨ÛŒØ´ØªØ±</button>
        <form class="comment-form d-flex gap-2 mt-3" data-post="${p.id}">
          <input type="text" class="form-control" placeholder="Ù†Ø¸Ø± Ø´Ù…Ø§..." required>
          <button class="btn btn-primary px-3">Ø§Ø±Ø³Ø§Ù„</button>
        </form>
      </div>

      </article>`;
        };

        // ---- Fetch Posts ----
        async function fetchMore() {
            if (loading || !nextUrl) return;
            loading = true;
            showSpinner(true);
            abortCtrl?.abort();
            abortCtrl = new AbortController();

            try {
                const res = await fetch(nextUrl, {signal: abortCtrl.signal});
                const data = await res.json();
                nextUrl = data.next || null;

                document.querySelectorAll(".skeleton").forEach((el) => el.remove());
                const html = (data.results || []).map(renderPostCard).join("");
                feedEl.insertAdjacentHTML("beforeend", html);
                bindActions();

                // Ø§Ú¯Ø± slug Ø®Ø§ØµÛŒ Ø¯Ø§Ø±ÛŒÙ…
                if (openSlug) {
                    const post = data.results.find((p) => p.slug === openSlug);
                    if (post) openPopup(post);
                    openSlug = "";
                }
            } catch (e) {
                console.warn("Fetch error:", e);
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø³Øªâ€ŒÙ‡Ø§ âŒ");
            } finally {
                loading = false;
                showSpinner(false);
                sentinel.style.opacity = nextUrl ? 1 : 0;
            }
        }

        // ---- Bind Actions ----
        function bindActions() {
            document.querySelectorAll(".like-btn:not([data-bound])").forEach((btn) => {
                btn.dataset.bound = "1";
                btn.addEventListener("click", async () => {
                    const id = btn.dataset.id;
                    const res = await fetch(`${API_BASE}${id}/like/`, {method: "POST"});
                    const data = await res.json();
                    if (data.likes !== undefined) {
                        btn.querySelector(".lcount").textContent = prettyNum(data.likes);
                        btn.classList.toggle("liked", data.liked);
                    }
                });
            });

            document.querySelectorAll(".share-btn").forEach(btn => {
                if (btn.dataset.bound) return;
                btn.dataset.bound = "1";

                btn.addEventListener("click", async e => {
                    e.preventDefault();
                    try {
                        await navigator.clipboard.writeText(btn.dataset.url);
                        showToast("Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯ âœ…");
                    } catch {
                    }
                });
            });


            document.querySelectorAll(".tag-link:not([data-bound])").forEach((a) => {
                a.dataset.bound = "1";
                a.addEventListener("click", (e) => {
                    e.preventDefault();
                    activeTag = a.dataset.tag;
                    updateUrl();
                    resetAndFetch();
                });
            });

            document.querySelectorAll(".comment-btn:not([data-bound])").forEach((btn) => {
                btn.dataset.bound = "1";
                btn.addEventListener("click", async () => {
                    const id = btn.dataset.id;
                    const res = await fetch(`${API_BASE}${id}/`);
                    const post = await res.json();
                    await loadComments(post.id)
                    history.pushState({}, "", `/post/${post.slug}/`);
                });
            });

            document.querySelectorAll(".comment-form:not([data-bound])").forEach(form => {
                form.dataset.bound = "1";
                form.addEventListener("submit", async e => {
                    e.preventDefault();
                    const postId = form.dataset.post;
                    const input = form.querySelector("input");
                    const text = input.value.trim();
                    if (!text) return;
                    input.disabled = true;
                    try {
                        await fetch(API_COMMENTS, {
                            method: "POST",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({post: postId, text})
                        });
                        input.value = "";
                        loadComments(postId);
                    } catch {
                    }
                    input.disabled = false;
                });
            });
        }

        async function loadComments(postId, page = 1) {
            const list = document.getElementById(`list-${postId}`);
            const moreBtn = document.getElementById(`loadmore-${postId}`);
            try {
                const res = await fetch(`${API_COMMENTS}?post=${postId}&page=${page}`);
                const data = await res.json();
                const comments = data.results || [];
                if (!comments.length) {
                    list.innerHTML = `<div class="text-muted small">Ù†Ø¸Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ ğŸ˜Œ</div>`;
                    return;
                }
                const html = comments
                    .slice(0, 5)
                    .map(c => `<div class="border rounded-3 p-2 mb-2"><div class="fw-bold small">${c.user_name || "Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†"}</div><p class="mb-1">${c.text}</p></div>`)
                    .join("");
                list.innerHTML = html;
                if (comments.length > 5) {
                    moreBtn.classList.remove("d-none");
                    moreBtn.onclick = () => {
                        const extra = comments.slice(5)
                            .map(c => `<div class="border rounded-3 p-2 mb-2"><div class="fw-bold small">${c.user_name || "Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†"}</div><p class="mb-1">${c.text}</p></div>`)
                            .join("");
                        list.insertAdjacentHTML("beforeend", extra);
                        moreBtn.remove();
                    };
                }
            } catch {
                list.innerHTML = `<div class="text-danger small">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø¸Ø±Ø§Øª âŒ</div>`;
            }
        }

        // ---- URL & Scroll ----
        function updateUrl() {
            const params = new URLSearchParams();
            if (activeTag) params.set("tag", activeTag);
            if (activeQuery) params.set("q", activeQuery);
            if (activeDate) params.set("date", activeDate);
            history.replaceState({}, "", params.toString() ? `/post/?${params}` : "/post/");
        }

        function resetAndFetch() {
            feedEl.innerHTML = renderSkeleton();
            nextUrl = buildApiUrl();
            fetchMore();
        }

        // ---- Infinite Scroll ----
        const io = new IntersectionObserver(
            (entries) => entries.forEach((e) => e.isIntersecting && fetchMore()),
            {rootMargin: "600px"}
        );
        io.observe(sentinel);

        // ---- Init ----
        resetAndFetch();
    })();
</script>


{% endblock %}
