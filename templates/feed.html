{% extends "base.html" %}
{% block content %}
<section class="feed-section py-5">
    <div class="container">

        <!-- Search Header -->
        <div class="feed-search bg-transparent">
            <div class="search-wrap shadow-sm rounded-4 p-2 p-md-3">
                <form class="row g-2 align-items-center" role="search" onsubmit="return false;">
                    <div class="col-12 col-md">
                        <div class="search-input d-flex align-items-center gap-2 px-3 py-2 rounded-3">
                            <i class="fa-solid fa-magnifying-glass search-ico"></i>
                            <input id="qInput" type="search" inputmode="search" autocomplete="off"
                                   class="form-control border-0 bg-transparent"
                                   placeholder="جستجو بین عنوان و متن پست‌ها…">
                            <button id="clearSearch" class="btn btn-clear d-none" type="button"
                                    aria-label="پاک کردن جستجو">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-6 col-md-auto">
                        <div class="date-chip d-flex align-items-center gap-2 px-3 py-2 rounded-3">
                            <i class="fa-regular fa-calendar"></i>
                            <input id="dateInput" type="date"
                                   class="form-control form-control-sm border-0 bg-transparent">
                            <button id="clearDate" class="btn btn-clear" type="button" aria-label="پاک کردن تاریخ">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- فید -->
        <div class="row justify-content-center mt-4">
            <div class="col-lg-8">
                <div id="feed"></div>

                <!-- Spinner مرکزی -->
                <div id="spinner" class="text-center py-4 d-none">
                    <div class="spinner-border text-success" role="status"></div>
                </div>

                <!-- sentinel برای اینفینیت اسکرول -->
                <div id="sentinel" class="py-4 text-center text-muted small">در حال بارگذاری…</div>
            </div>
        </div>

        <!-- Toast برای share -->
        <div id="toast" class="position-fixed bottom-0 end-0 m-4 bg-dark text-white px-3 py-2 rounded-3 d-none shadow">
            کپی شد ✅
        </div>
    </div>
</section>

<script>
    (function () {
        const API_BASE = "/post/api/posts/";
        let nextUrl = null;
        let loading = false;
        let abortCtrl = null;

        const feedEl = document.getElementById("feed");
        const sentinel = document.getElementById("sentinel");
        const spinner = document.getElementById("spinner");
        const toast = document.getElementById("toast");
        const qInput = document.getElementById("qInput");
        const dateInput = document.getElementById("dateInput");

        let activeTag = new URLSearchParams(location.search).get("tag") || "";
        let activeQuery = new URLSearchParams(location.search).get("q") || "";
        let activeDate = new URLSearchParams(location.search).get("date") || "";

        function showSpinner(state = true) {
            spinner.classList.toggle("d-none", !state);
        }

        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.remove("d-none");
            setTimeout(() => toast.classList.add("d-none"), 1500);
        }

        function prettyNum(num) {
            if (num > 999999) return (num / 1e6).toFixed(1) + 'M';
            if (num > 999) return (num / 1e3).toFixed(1) + 'K';
            return num;
        }

        function buildApiUrl(pageUrl = null) {
            if (pageUrl) return pageUrl;
            const params = new URLSearchParams();
            if (activeTag) params.set("tags__slug", activeTag);
            if (activeQuery) params.set("search", activeQuery);
            if (activeDate) params.set("created_at__date", activeDate);
            const qs = params.toString();
            return qs ? `${API_BASE}?${qs}` : API_BASE;
        }

        function renderSkeleton() {
            return `
      <div class="skeleton rounded-4 mb-4 p-4 bg-white shadow-sm">
        <div class="placeholder-glow mb-3">
          <div class="placeholder col-7"></div>
          <div class="placeholder col-4"></div>
        </div>
        <div class="placeholder-glow">
          <div class="placeholder col-12 mb-2"></div>
          <div class="placeholder col-10"></div>
        </div>
      </div>
    `;
        }

        function renderPostCard(p) {
            const media = p.image
                ? `<img src="${p.image}" class="img-fluid rounded mb-3" alt="${p.title}" loading="lazy">`
                : (p.video ? `<video class="w-100 rounded mb-3" controls preload="metadata" src="${p.video}"></video>` : "");
            const date = new Date(p.created_at).toLocaleString("fa-IR");
            const tags = (p.tags || [])
                .map(t => `<a href="#" class="tag-link badge bg-light text-dark border me-1" data-tag="${t.slug || t.name}"># ${t.name}</a>`)
                .join("");
            const short = p.content.length > 550
                ? `${p.content.slice(0, 550)}… <a href="/post/${p.slug}/" class="text-decoration-none fw-semibold">ادامه مطلب</a>`
                : p.content;

            return `
  <article class="post-card rounded-4 shadow-sm bg-white p-4 mb-4" data-id="${p.id}">
       <header class="d-flex align-items-center mb-3 justify-content-between">
        <div class="d-flex align-items-center">
          <img src="/static/images/logo.png" width="40" height="40" class="rounded-circle ms-2" alt="ALH">
          <div>
            <div class="fw-bold">عباس لطفی نسب</div>
            <div class="small text-muted">${date}</div>
          </div>
        </div>
        <div class="share-btn more-link btn" data-url="${location.origin}/post/${p.slug}/">
        <i class="fa-solid fa-share"></i>
        </div>
      </header>

    <div class="fw-bold mb-2">${p.title}</div>
    <p class="mb-4" dir="auto">${short}</p>
    <div class="small mb-3">${tags}</div>
    ${media}

   <div class="post-actions d-flex gap-3 border-top pt-2 mt-3">
      <!-- Views -->
      <button class="action-btn btn view-btn">
        <i class="fa-solid fa-eye"></i> <span>123</span>
      </button>

      <!-- Likes -->
     <button class="action-btn btn like-btn ${p.liked ? "liked" : ""}" data-id="${p.id}">
  <i class="fa-solid fa-heart"></i>
  <span class="lcount">${prettyNum(p.likes)}</span>
</button>


      <!-- Comments -->
      <button class="action-btn btn comment-btn " data-id="${p.id}">
        <i class="fa-solid fa-comment"></i> <span>${p.comments_count}</span>
      </button>

   </div>
  </article>`;
        }


        async function fetchMore() {
            if (loading || !nextUrl) return;
            loading = true;
            showSpinner(true);
            abortCtrl?.abort();
            abortCtrl = new AbortController();

            try {
                const res = await fetch(nextUrl, {signal: abortCtrl.signal});
                const data = await res.json();
                const {results, next} = Array.isArray(data) ? {results: data, next: null} : data;
                nextUrl = next;

                // remove skeletons after first load
                document.querySelectorAll(".skeleton").forEach(el => el.remove());

                const html = (results || []).map(renderPostCard).join("");
                feedEl.insertAdjacentHTML("beforeend", html);
                bindActions();
            } catch (e) {
                console.warn("Request cancelled or failed:", e);
            } finally {
                loading = false;
                showSpinner(false);
                sentinel.style.opacity = nextUrl ? 1 : 0;
            }
        }

        function bindActions() {
            // Like
            document.querySelectorAll(".like-btn").forEach(btn => {
                if (btn.dataset.bound) return;
                btn.dataset.bound = "1";

                btn.addEventListener("click", async () => {
                    const icon = btn.querySelector("i");
                    const id = btn.dataset.id;

                    const res = await fetch(`${API_BASE}${id}/like/`, {method: "POST"});
                    const data = await res.json();

                    if (data.likes !== undefined) {
                        btn.querySelector(".lcount").textContent = prettyNum(data.likes);
                        if (data.liked) {
                            btn.classList.add("liked");
                        } else {
                            btn.classList.remove("liked");
                        }

                    }
                });

            });

            // Share
            document.querySelectorAll(".share-btn").forEach(b => {
                if (b.dataset.bound) return;
                b.dataset.bound = "1";

                b.addEventListener("click", async () => {
                    try {
                        await navigator.clipboard.writeText(b.dataset.url);
                        showToast("لینک کپی شد ✅");
                    } catch {
                    }
                });
            });

            // Tags
            document.querySelectorAll(".tag-link").forEach(a => {
                if (a.dataset.bound) return;
                a.dataset.bound = "1";

                a.addEventListener("click", ev => {
                    ev.preventDefault();
                    activeTag = a.dataset.tag || "";
                    resetAndFetch();
                });
            });
        }


        const io = new IntersectionObserver((entries) => {
            entries.forEach(e => {
                if (e.isIntersecting) fetchMore();
            });
        }, {rootMargin: "600px"});
        io.observe(sentinel);

        function resetAndFetch() {
            // فقط یک skeleton برای loading اولیه
            feedEl.innerHTML = renderSkeleton();
            nextUrl = buildApiUrl();
            fetchMore();
        }

        nextUrl = buildApiUrl();
        resetAndFetch();
    })();
</script>


{% endblock %}
