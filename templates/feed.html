{% extends "base.html" %}

{% block content %}

<section class="feed-section py-5">
  <div class="container">
    <!-- Search Header -->
    <div class="feed-search bg-transparent">
      <div class="search-wrap shadow-sm rounded-4 p-2 p-md-3">
        <form class="row g-2 align-items-center" role="search" onsubmit="return false;">
          <!-- Ø³Ø±Ú† -->
          <div class="col-12 col-md">
            <div class="search-input d-flex align-items-center gap-2 px-3 py-2 rounded-3">
              <i class="fa-solid fa-magnifying-glass search-ico"></i>
              <input id="qInput" type="search" inputmode="search" autocomplete="off"
                     class="form-control border-0 bg-transparent"
                     placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨ÛŒÙ† Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù…ØªÙ† Ù¾Ø³Øªâ€ŒÙ‡Ø§â€¦">
              <button id="clearSearch" class="btn btn-clear d-none" type="button" aria-label="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¬Ø³ØªØ¬Ùˆ">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          </div>

          <!-- ØªØ§Ø±ÛŒØ® -->
          <div class="col-6 col-md-auto">
            <div class="date-chip d-flex align-items-center gap-2 px-3 py-2 rounded-3">
              <i class="fa-regular fa-calendar"></i>
              <input id="dateInput" type="date" class="form-control form-control-sm border-0 bg-transparent">
              <button id="clearDate" class="btn btn-clear" type="button" aria-label="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          </div>

        </form>

      </div>
    </div>

    <!-- ÙÛŒØ¯ -->
    <div class="row justify-content-center mt-4">
      <div class="col-lg-8">
        <div id="feed"></div>
        <!-- sentinel Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†ÙÛŒÙ†ÛŒØª Ø§Ø³Ú©Ø±ÙˆÙ„ -->
        <div id="sentinel" class="py-4 text-center text-muted small">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>
      </div>
    </div>
  </div>
</section>


<script>
    (function () {
        const API_BASE = "/post/api/posts/";
        let nextUrl = null;
        let loading = false;

        // Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§
        let activeTag = new URLSearchParams(location.search).get("tag") || "";
        let activeQuery = new URLSearchParams(location.search).get("q") || "";
        let activeDate = new URLSearchParams(location.search).get("date") || "";

        const feedEl = document.getElementById("feed");
        const sentinel = document.getElementById("sentinel");
        const qInput = document.getElementById("qInput");
        const dateInput = document.getElementById("dateInput");

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ UI
        if (qInput) qInput.value = activeQuery;
        if (dateInput && activeDate) dateInput.value = activeDate;

        // Ø³Ø§Ø®Øª URL Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ ÙÛŒÙ„ØªØ±Ù‡Ø§
        function buildApiUrl(pageUrl = null) {
            if (pageUrl) return pageUrl; // Ø¨Ø±Ø§ÛŒ next
            const params = new URLSearchParams();
            if (activeTag) params.set("tags__slug", activeTag);
            if (activeQuery) params.set("search", activeQuery);
            if (activeDate) params.set("created_at__date", activeDate);
            const qs = params.toString();
            return qs ? `${API_BASE}?${qs}` : API_BASE;
        }

        function pushUrl() {
            const params = new URLSearchParams();
            if (activeTag) params.set("tag", activeTag);
            if (activeQuery) params.set("q", activeQuery);
            if (activeDate) params.set("date", activeDate);
            const qs = params.toString();
            history.replaceState({}, "", qs ? `?${qs}` : location.pathname);
        }

        // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ pill ØªÚ¯â€ŒÙ‡Ø§
        function setActivePillByTag(slug) {
            document.querySelectorAll(".tag-pill").forEach(b => {
                b.classList.toggle("active", (b.dataset.tag || "") === (slug || ""));
            });
        }

        // Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ pills ØªÚ¯
        document.querySelectorAll(".tag-pill").forEach(btn => {
            btn.addEventListener("click", () => {
                activeTag = btn.dataset.tag || "";
                setActivePillByTag(activeTag);
                resetAndFetch();
            });
        });

        // debounce Ø¬Ø³ØªØ¬Ùˆ
        let qTimer;
        if (qInput) {
            qInput.addEventListener("input", () => {
                clearTimeout(qTimer);
                qTimer = setTimeout(() => {
                    activeQuery = qInput.value.trim();
                    resetAndFetch();
                }, 400);
            });
        }

        // ÙÛŒÙ„ØªØ± ØªØ§Ø±ÛŒØ® Ø±ÙˆØ²
        if (dateInput) {
            dateInput.addEventListener("change", () => {
                activeDate = dateInput.value || "";
                resetAndFetch();
            });
        }

        // Ø±Ù†Ø¯Ø± Ú©Ø§Ø±Øª
        function renderPostCard(p) {
            const media = p.image ? `<img src="${p.image}" class="img-fluid rounded mb-3" alt="" loading="lazy">`
                : (p.video ? `<video class="w-100 rounded mb-3" controls preload="metadata" src="${p.video}"></video>` : "");
            const date = new Date(p.created_at).toLocaleString("fa-IR");
            const tags = (p.tags || [])
                .map(t => `<a href="#" class="tag-link badge bg-light text-dark border me-1" data-tag="${t.slug || t.name}"># ${t.name}</a>`)
                .join("");

            return `
    <article class="post-card rounded-4 shadow-sm bg-white p-4 mb-4" data-id="${p.id}">
      <header class="d-flex align-items-center mb-3">
        <img src="/static/images/logo.png" width="40" height="40" class="rounded-circle ms-2" alt="ALH">
        <div>
          <div class="fw-bold">Ø¹Ø¨Ø§Ø³ Ù„Ø·ÙÛŒ Ù†Ø³Ø¨</div>
          <div class="small text-muted">${date}</div>
        </div>
      </header>
      <div class="fw-bold mb-2">${p.title}</div>
      <p class="mb-4" dir="auto">${p.content.length > 550 ? p.content.slice(0, 550) + 'â€¦' : p.content}</p>
      <div class="small mb-3">${tags}</div>
      ${media}
     <div class="d-flex gap-3 align-items-center text-muted small mb-2">
  <div class="d-flex align-items-center gap-1 px-2 py-1 rounded-pill bg-light">
    <i data-lucide="eye"></i>
    <span class="vcount">${p.views}</span>
  </div>
  <div class="d-flex align-items-center gap-1 px-2 py-1 rounded-pill bg-light">
    <i data-lucide="heart"></i>
    <span class="lcount">120</span>
  </div>
  <div class="d-flex align-items-center gap-1 px-2 py-1 rounded-pill bg-light">
    <i data-lucide="message-circle"></i>
    <span>15</span>
  </div>
</div>

      <div class="d-flex justify-content-around border-top pt-2">
        <button class="btn btn-sm btn-light like-btn" data-id="${p.id}">ğŸ‘ Ù¾Ø³Ù†Ø¯ÛŒØ¯Ù…</button>
        <a class="btn btn-sm btn-light" href="/notes/${p.slug}/">Ø®ÙˆØ§Ù†Ø¯Ù† Ú©Ø§Ù…Ù„</a>
        <button class="btn btn-sm btn-light share-btn" data-url="${location.origin}/notes/${p.slug}/">â†—ï¸ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ</button>
      </div>
    </article>`;
        }

        // fetch Ø¨Ø¹Ø¯ÛŒ
        async function fetchMore() {
            if (loading || !nextUrl) return;
            loading = true;
            sentinel.style.opacity = 1;
            try {
                const res = await fetch(nextUrl);
                const data = await res.json();
                const {results, next} = Array.isArray(data) ? {results: data, next: null} : data;
                nextUrl = next;
                const html = (results || []).map(renderPostCard).join("");
                feedEl.insertAdjacentHTML("beforeend", html);
                bindActions();
                observeCardsForView();
            } finally {
                sentinel.style.opacity = nextUrl ? 1 : 0;
                loading = false;
            }
        }

        // Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§
        function bindActions() {
            document.querySelectorAll(".like-btn").forEach(btn => {
                if (btn.dataset.bound) return;
                btn.dataset.bound = "1";
                btn.addEventListener("click", async () => {
                    const id = btn.dataset.id;
                    const res = await fetch(`${API_BASE}${id}/like/`, {method: "POST"});
                    const data = await res.json();
                    const card = btn.closest(".post-card");
                    if (card && data.likes !== undefined) {
                        card.querySelector(".lcount").textContent = data.likes;
                        btn.classList.add("btn-primary");
                        btn.classList.remove("btn-light");
                    }
                });
            });
            document.querySelectorAll(".share-btn").forEach(b => {
                if (b.dataset.bound) return;
                b.dataset.bound = "1";
                b.addEventListener("click", async () => {
                    try {
                        await navigator.clipboard.writeText(b.dataset.url);
                        b.textContent = "Ú©Ù¾ÛŒ Ø´Ø¯";
                        setTimeout(() => b.textContent = "â†—ï¸ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ", 1000);
                    } catch (e) {
                    }
                });
            });
            document.querySelectorAll(".tag-link").forEach(a => {
                if (a.dataset.bound) return;
                a.dataset.bound = "1";
                a.addEventListener("click", (ev) => {
                    ev.preventDefault();
                    activeTag = a.dataset.tag || "";
                    setActivePillByTag(activeTag);
                    resetAndFetch();
                });
            });
        }

        // Ø«Ø¨Øª Ø¨Ø§Ø²Ø¯ÛŒØ¯ ÙˆÙ‚ØªÛŒ Ú©Ø§Ø±Øª Ø¯ÛŒØ¯Ù‡ Ø´Ø¯
        let cardObserver;

        function observeCardsForView() {
            if (!cardObserver) {
                cardObserver = new IntersectionObserver((entries) => {
                    entries.forEach(e => {
                        if (e.isIntersecting && !e.target.dataset.viewed) {
                            e.target.dataset.viewed = "1";
                            const id = e.target.dataset.id;
                            fetch(`${API_BASE}${id}/viewed/`, {method: "POST"});
                        }
                    });
                }, {threshold: 0.5});
            }
            document.querySelectorAll(".post-card").forEach(card => cardObserver.observe(card));
        }

        // Ø§ÛŒÙ†ÙÛŒÙ†ÛŒØª Ø§Ø³Ú©Ø±ÙˆÙ„
        const io = new IntersectionObserver((entries) => {
            entries.forEach(e => {
                if (e.isIntersecting) fetchMore();
            });
        }, {rootMargin: "600px"});
        io.observe(sentinel);

        // Ø±ÛŒØ³Øª Ùˆ fetch
        function resetAndFetch() {
            pushUrl();
            feedEl.innerHTML = "";
            nextUrl = buildApiUrl();
            fetchMore();
        }

        // Init
        setActivePillByTag(activeTag);
        nextUrl = buildApiUrl();
        fetchMore();
    })();
</script>

<script>
    (function () {
        const qInput = document.getElementById("qInput");
        const clearSearch = document.getElementById("clearSearch");
        const dateInput = document.getElementById("dateInput");
        const clearDate = document.getElementById("clearDate");
        const clearAll = document.getElementById("clearAll");

        // Ù†Ù…Ø§ÛŒØ´/Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† Ø³Ø±Ú†
        function syncClearBtn() {
            if (!qInput) return;
            clearSearch.classList.toggle("d-none", qInput.value.trim() === "");
        }

        qInput && qInput.addEventListener("input", syncClearBtn);
        clearSearch && clearSearch.addEventListener("click", () => {
            qInput.value = "";
            qInput.dispatchEvent(new Event("input")); // ØªØ§ debounce Ø´Ù…Ø§ ØªØ±ÛŒÚ¯Ø± Ø´ÙˆØ¯
        });

        // Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®
        clearDate && clearDate.addEventListener("click", () => {
            if (dateInput) {
                dateInput.value = "";
                dateInput.dispatchEvent(new Event("change"));
            }
        });

        // Ø§Ø¬Ø±Ø§ Ø§ÙˆÙ„
        syncClearBtn();
    })();
</script>


{% endblock %}
