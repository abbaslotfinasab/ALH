{% extends "base.html" %}
{% load static %}

{% block extra_head %}

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "CollectionPage",
        "name": "{{ seo_title|escapejs }}",
        "description": "{{ seo_description|escapejs }}",
        "url": "{{ canonical_url|default:request.build_absolute_uri }}",
        "hasPart": [
            {% for post in blog_posts %}
            {
                "@type": "BlogPosting",
                "headline": "{{ post.title|escapejs }}",
                "url": "{{ request.build_absolute_uri }}{{ post.get_absolute_url }}",
                "datePublished": "{{ post.published_date|date:'Y-m-d' }}",
                "description": "{{ post.meta_description|default:post.content|truncatechars:160|escapejs }}"
            }
            {% if not for loop.last %},
            {% endif %}
            {% endfor %}
        ],
        "publisher": {
            "@type": "Organization",
            "name": "abbaslotfinasab.ir",
            "logo": {
                "@type": "ImageObject",
                "url": "{% static 'images/logo.png' %}"
            }
        }
    }
</script>

{% endblock %}

{% block content %}


<section class="feed-section py-5">
    <div class="container">
        <!-- Search Header -->
        <div class="feed-search bg-transparent">
            <div class="search-wrap shadow-sm rounded-4 p-2 p-md-3">
                <form class="row g-2 align-items-center" role="search" onsubmit="return false;">
                    <!-- سرچ -->
                    <div class="col-12 col-md">
                        <div class="search-input d-flex align-items-center gap-2 px-3 py-2 rounded-3">
                            <i class="fa-solid fa-magnifying-glass search-ico"></i>
                            <input id="qInput" type="search" inputmode="search" autocomplete="off"
                                   class="form-control border-0 bg-transparent"
                                   placeholder="جستجو بین عنوان و متن پژوهش ها…">
                            <button id="clearSearch" class="btn btn-clear d-none" type="button"
                                    aria-label="پاک کردن جستجو">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>

                    <!-- تاریخ -->
                    <div class="col-6 col-md-auto">
                        <div class="date-chip d-flex align-items-center gap-2 px-3 py-2 rounded-3">
                            <i class="fa-regular fa-calendar"></i>
                            <input id="dateInput" type="date"
                                   class="form-control form-control-sm border-0 bg-transparent">
                            <button id="clearDate" class="btn btn-clear" type="button" aria-label="پاک کردن تاریخ">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>

                </form>

            </div>
        </div>

        <div class="row g-4 py-5">
            {% for post in blog_posts %}
            <div class="col-md-6 col-lg-4">
                <article class="card h-100 shadow-sm border-0"
                         data-title="{{ post.title|lower }}"
                         data-content="{{ post.content|striptags|lower }}"
                         data-tags="{% for keywords in post.keywords.all %}{{ keywords.slug }}{% if not forloop.last %},{% endif %}{% endfor %}"
                         data-date="{{ post.created_at|date:'Y-m-d' }}"
                         data-id="{{ post.id }}"
                         data-slug="{{ post.slug }}"
                >
                    {% if post.image %}
                    <img src="{{ post.image.url }}" class="card-img-top" alt="{{ post.title }}">
                    {% else %}
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center"
                         style="height:180px;">
                        <i data-lucide="file-text" class="fs-1 text-secondary"></i>
                    </div>
                    {% endif %}
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title"><a href="{{ post.get_absolute_url }}" class="text-dark">{{
                            post.title}}</a></h5>
                        <p class="card-text text-muted small">{{ post.content|truncatewords:25 }}</p>
                        <div class="mt-auto d-flex justify-content-between align-items-center pt-3">
                            <a href="{% url 'blogs:detail' post.slug %}" class="btn btn-sm btn-primary">خواندن</a>
                        </div>
                    </div>
                </article>
            </div>
            {% endfor %}
        </div>

        <div class="mt-4">
            {% if is_paginated %}
            <nav aria-label="Pagination">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item"><a class="page-link"
                                             href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{request.GET.q}}{% endif %}">قبلی</a>
                    </li>
                    {% endif %}
                    <li class="page-item disabled"><span class="page-link">صفحه {{ page_obj.number }} از {{ page_obj.paginator.num_pages }}</span>
                    </li>
                    {% if page_obj.has_next %}
                    <li class="page-item"><a class="page-link"
                                             href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{request.GET.q}}{% endif %}">بعدی</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</section>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const qInput = document.getElementById("qInput");
        const dateInput = document.getElementById("dateInput");
        const clearSearch = document.getElementById("clearSearch");
        const clearDate = document.getElementById("clearDate");
        const articles = document.querySelectorAll(".card"); // همه کارت‌های مقاله

        // --- تابع فیلتر ---
        function filterArticles() {
            const searchTerm = qInput.value.toLowerCase().trim();
            const selectedDate = dateInput.value;

            let visibleCount = 0;

            articles.forEach((card) => {
                const title = card.querySelector(".card-title").innerText.toLowerCase();
                const content = card.querySelector(".card-text").innerText.toLowerCase();
                const publishedDate = card.querySelector("[data-published-date]")?.dataset.publishedDate || "";

                const matchesSearch =
                    title.includes(searchTerm) || content.includes(searchTerm);
                const matchesDate = selectedDate ? publishedDate.startsWith(selectedDate) : true;

                if (matchesSearch && matchesDate) {
                    card.parentElement.style.display = "block";
                    visibleCount++;
                } else {
                    card.parentElement.style.display = "none";
                }
            });

            // اگر هیچ نتیجه‌ای نبود
            if (visibleCount === 0) {
                if (!document.getElementById("noResults")) {
                    const div = document.createElement("div");
                    div.id = "noResults";
                    div.className = "text-center text-muted mt-5";
                    div.innerHTML = "<p>نتیجه‌ای یافت نشد.</p>";
                    document.querySelector(".row.g-4").appendChild(div);
                }
            } else {
                document.getElementById("noResults")?.remove();
            }
        }

        // --- رویدادها ---
        qInput.addEventListener("input", () => {
            clearSearch.classList.toggle("d-none", qInput.value === "");
            filterArticles();
        });

        clearSearch.addEventListener("click", () => {
            qInput.value = "";
            clearSearch.classList.add("d-none");
            filterArticles();
        });

        dateInput.addEventListener("change", () => {
            clearDate.classList.toggle("d-none", dateInput.value === "");
            filterArticles();
        });

        clearDate.addEventListener("click", () => {
            dateInput.value = "";
            clearDate.classList.add("d-none");
            filterArticles();
        });
    });
</script>


{% endblock %}
